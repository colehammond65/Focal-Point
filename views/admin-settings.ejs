<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= settings.siteTitle || "Anne's Photography" %>
    </title>
    <% if (settings.favicon) { %>
        <link rel="icon" type="image/png" href="/uploads/<%= settings.favicon %>">
        <% } %>
            <link rel="stylesheet" href="/styles.css">
</head>

<body>
    <%- include('partials/header', { showAdminNav: true }) %>
        <div class="container">
            <h1>Site Settings</h1>
            <% if (typeof req !=='undefined' && req.query && req.query.msg) { %>
                <div class="admin-msg" aria-live="polite">
                    <%= req.query.msg %>
                </div>
                <% } %>
                    <div class="settings-flex-row">
                        <section class="admin-card">
                            <form action="/admin/settings" method="POST" enctype="multipart/form-data"
                                class="admin-form">
                                <label for="siteTitle">Site Name (browser tab):</label>
                                <input type="text" id="siteTitle" name="siteTitle" value="<%= settings.siteTitle %>"
                                    required>

                                <label for="headerTitle">Header Title:</label>
                                <input type="text" id="headerTitle" name="headerTitle"
                                    value="<%= settings.headerTitle %>" required>

                                <label for="favicon" style="margin-bottom:0;">Favicon (image, optional):</label>
                                <div id="faviconDropzone" class="dropzone" tabindex="0" style="flex: 1 1 auto;">
                                    <span id="faviconDropzoneText">Drag & drop favicon here or click to select</span>
                                    <input type="file" id="favicon" name="favicon" accept="image/*"
                                        style="display:none;">
                                    <span id="faviconFileName"
                                        style="margin-left:1rem;color:#0078d4;font-weight:600;"></span>
                                    <% if (settings.favicon) { %>
                                        <div
                                            style="display: flex; flex-direction: column; align-items: center; min-width: 70px;">
                                            <span
                                                style="font-weight: 600; font-size: 1rem; color: #555; margin-bottom: 0.2rem;">Preview</span>
                                            <img src="/uploads/<%= settings.favicon %>" alt="Current favicon"
                                                class="favicon-preview">
                                        </div>
                                        <% } %>
                                </div>
                                <button type="submit">Save Settings</button>
                            </form>
                        </section>
                        <section class="admin-card">
                            <h2>Backup & Restore</h2>
                            <form action="/admin/backup" method="GET" style="margin-bottom:1rem;">
                                <button type="submit">Download Backup</button>
                            </form>
                            <form action="/admin/restore" method="POST" enctype="multipart/form-data"
                                onsubmit="return confirm('This will overwrite your current database and images. Continue?');"
                                id="restoreForm">
                                <div id="restoreDropzone" class="dropzone" tabindex="0">
                                    <span id="restoreDropzoneText">Drag & drop backup ZIP here or click to select</span>
                                    <input type="file" name="backup" id="restoreFileInput" accept=".zip" required
                                        style="display:none;">
                                    <span id="restoreFileName"
                                        style="margin-left:1rem;color:#0078d4;font-weight:600;"></span>
                                </div>
                                <button type="submit" id="restoreBtn" disabled>Restore Backup</button>
                            </form>
                            <p style="font-size:0.95em;color:#888;">Backups are ZIP files containing your database and
                                all
                                images.</p>
                        </section>
                    </div>
        </div>
        <%- include('partials/dark-mode-toggle') %>
            <script>
                const restoreDropzone = document.getElementById('restoreDropzone');
                const restoreFileInput = document.getElementById('restoreFileInput');
                const restoreFileName = document.getElementById('restoreFileName');
                const restoreBtn = document.getElementById('restoreBtn');

                restoreDropzone.addEventListener('click', () => restoreFileInput.click());
                restoreDropzone.addEventListener('keydown', e => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        restoreFileInput.click();
                    }
                });
                restoreDropzone.addEventListener('dragover', e => {
                    e.preventDefault();
                    restoreDropzone.classList.add('dragover');
                });
                restoreDropzone.addEventListener('dragleave', e => {
                    e.preventDefault();
                    restoreDropzone.classList.remove('dragover');
                });
                restoreDropzone.addEventListener('drop', e => {
                    e.preventDefault();
                    restoreDropzone.classList.remove('dragover');
                    if (e.dataTransfer.files.length) {
                        restoreFileInput.files = e.dataTransfer.files;
                        updateRestoreFileName();
                    }
                });
                restoreFileInput.addEventListener('change', updateRestoreFileName);

                function updateRestoreFileName() {
                    if (restoreFileInput.files.length) {
                        restoreFileName.textContent = restoreFileInput.files[0].name;
                        restoreBtn.disabled = false;
                    } else {
                        restoreFileName.textContent = '';
                        restoreBtn.disabled = true;
                    }
                }
            </script>
            <script>
                const faviconDropzone = document.getElementById('faviconDropzone');
                const faviconInput = document.getElementById('favicon');
                const faviconFileName = document.getElementById('faviconFileName');

                if (faviconDropzone && faviconInput && faviconFileName) {
                    faviconDropzone.addEventListener('click', () => faviconInput.click());
                    faviconDropzone.addEventListener('keydown', e => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            faviconInput.click();
                        }
                    });
                    faviconDropzone.addEventListener('dragover', e => {
                        e.preventDefault();
                        faviconDropzone.classList.add('dragover');
                    });
                    faviconDropzone.addEventListener('dragleave', e => {
                        e.preventDefault();
                        faviconDropzone.classList.remove('dragover');
                    });
                    faviconDropzone.addEventListener('drop', e => {
                        e.preventDefault();
                        faviconDropzone.classList.remove('dragover');
                        if (e.dataTransfer.files.length) {
                            faviconInput.files = e.dataTransfer.files;
                            updateFaviconFileName();
                        }
                    });
                    faviconInput.addEventListener('change', updateFaviconFileName);

                    function updateFaviconFileName() {
                        if (faviconInput.files.length) {
                            faviconFileName.textContent = faviconInput.files[0].name;
                        } else {
                            faviconFileName.textContent = '';
                        }
                    }
                }
            </script>
</body>

</html>