<!--
  admin-manage.ejs
  Admin interface for managing images and categories.
  Includes sortable image/category lists, upload forms, and toast notifications.
  Uses SortableJS for drag-and-drop reordering.
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= settings.siteTitle || "Focal Point" %> - Manage Images & Categories
    </title>
    <% if (settings.favicon) { %>
        <link rel="icon" type="image/png" href="/branding/<%= settings.favicon %>">
        <% } %>
            <link rel="stylesheet" href="/styles.css?v=<%= encodeURIComponent(settings.accentColor || '') %>">
            <style>
                :root {
                    --primary-color: <%=settings.accentColor || '#2ecc71' %>;
                    --primary-hover: <%=settings.accentColor ? (settings.accentColor.replace('#', '%23') + 'cc'): '#27ae60' %>;
                }
            </style>
            <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>

<body>
    <%- include('partials/header', { showAdminNav: true, settings, loggedIn: true }) %>
        <div class="container">
            <div id="toast-container" class="toast-container"></div>
            <script src="/js/toast.js"></script>
            <% if (typeof req !=='undefined' && req.query && req.query.msg) { %>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        showToast("<%= (req.query.msg + '').replace(/\"/g, '&quot;') %>");
                    });
                </script>
                <% } %>
                    <h1>Image & Category Management</h1>
                    <div class="admin-flex-row">
                        <!-- Upload Images Form -->
                        <section class="admin-card">
                            <h2>Upload Images</h2>
                            <form action="/admin/upload" method="POST" enctype="multipart/form-data" class="admin-form">
                                <label for="image">Choose image(s):</label>
                                <p class="backup-note">Max 20 images at a time. Max 10MB per image. Supported formats:
                                    JPG, PNG, GIF.</p>
                                <div id="dropzone" class="dropzone" tabindex="0">Drag & drop images here or click to
                                    select</div>
                                <input type="file" name="images" id="image" multiple required style="display:none;"
                                    accept="image/png,image/jpeg,image/gif" onchange="validateImages(this)">
                                <div id="preview" class="preview"></div>
                                <script>
                                    document.addEventListener('DOMContentLoaded', function () {
                                        const dropzone = document.getElementById('dropzone');
                                        const fileInput = document.getElementById('image');
                                        const preview = document.getElementById('preview');
                                        if (dropzone && fileInput) {
                                            dropzone.addEventListener('click', function () {
                                                fileInput.click();
                                            });
                                            dropzone.addEventListener('keydown', function (e) {
                                                if (e.key === 'Enter' || e.key === ' ') {
                                                    e.preventDefault();
                                                    fileInput.click();
                                                }
                                            });
                                            dropzone.addEventListener('dragover', function (e) {
                                                e.preventDefault();
                                                dropzone.classList.add('dragover');
                                            });
                                            dropzone.addEventListener('dragleave', function (e) {
                                                e.preventDefault();
                                                dropzone.classList.remove('dragover');
                                            });
                                            dropzone.addEventListener('drop', function (e) {
                                                e.preventDefault();
                                                dropzone.classList.remove('dragover');
                                                if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                                                    // Create a new DataTransfer to assign files
                                                    const dt = new DataTransfer();
                                                    Array.from(e.dataTransfer.files).forEach(file => dt.items.add(file));
                                                    fileInput.files = dt.files;
                                                    fileInput.dispatchEvent(new Event('change', { bubbles: true }));
                                                }
                                            });
                                            // Add preview logic
                                            fileInput.addEventListener('change', function () {
                                                preview.innerHTML = '';
                                                if (fileInput.files && fileInput.files.length > 0) {
                                                    Array.from(fileInput.files).forEach(file => {
                                                        if (file.type.startsWith('image/')) {
                                                            const reader = new FileReader();
                                                            reader.onload = function (e) {
                                                                const img = document.createElement('img');
                                                                img.src = e.target.result;
                                                                img.alt = file.name;
                                                                img.style.maxWidth = '70px';
                                                                img.style.maxHeight = '70px';
                                                                img.style.margin = '0.2em';
                                                                preview.appendChild(img);
                                                            };
                                                            reader.readAsDataURL(file);
                                                        }
                                                    });
                                                }
                                            });
                                        }
                                    });

                                    function validateImages(input) {
                                        const maxFiles = 20;
                                        const maxSize = 10 * 1024 * 1024; // 10MB
                                        const allowedTypes = ['image/png', 'image/jpeg', 'image/gif'];
                                        if (input.files.length > maxFiles) {
                                            alert('You can upload up to 20 images at a time.');
                                            input.value = '';
                                            return false;
                                        }
                                        for (let file of input.files) {
                                            if (!allowedTypes.includes(file.type)) {
                                                alert('Invalid file type: ' + file.type);
                                                input.value = '';
                                                return false;
                                            }
                                            if (file.size > maxSize) {
                                                alert('File too large: ' + file.name);
                                                input.value = '';
                                                return false;
                                            }
                                        }
                                        return true;
                                    }
                                </script>
                                <% if (categories.length> 0) { %>
                                    <label for="category">Select a category:</label>
                                    <select name="category" id="category" required>
                                        <% categories.forEach(cat=> { %>
                                            <option value="<%= cat.name %>">
                                                <%= cat.name.replace(/-/g, ' ' ).replace(/\b\w/g, c=> c.toUpperCase())
                                                    %>
                                            </option>
                                            <% }); %>
                                    </select>
                                    <% } else { %>
                                        <p class="admin-error">
                                            No categories found. Please create a category first using the form on the
                                            right.
                                        </p>
                                        <% } %>
                                            <button type="submit" class="btn btn-primary" <%=categories.length===0
                                                ? 'disabled' : '' %>>Upload</button>
                            </form>
                        </section>

                        <!-- Create Category Form -->
                        <section class="admin-card">
                            <h2>Create Category</h2>
                            <form action="/admin/create-category" method="POST" class="admin-form row-gap">
                                <label for="newCategory" class="visually-hidden">New Category Name</label>
                                <input type="text" id="newCategory" name="newCategory" placeholder="New category name"
                                    required class="flex-1" maxlength="32" pattern="[A-Za-z0-9_\- ]{3,32}"
                                    autocomplete="off">
                                <button type="submit" class="btn btn-primary">Create</button>
                            </form>
                        </section>
                    </div>

                    <!-- Categories Section -->
                    <section class="admin-card admin-card-categories">
                        <h2>Categories</h2>
                        <% if (categories.length> 0) { %>
                            <div id="category-list">
                                <% categories.forEach(cat=> { %>
                                    <section class="admin-card category-accordion" data-cat="<%= cat.name %>">
                                        <div class="category-toggle" tabindex="0" draggable="true" aria-expanded="false"
                                            aria-controls="cat-<%= cat.name %>-panel">
                                            <span class="category-title">
                                                <%= cat.name.replace(/-/g, ' ' ).replace(/\b\w/g, c=> c.toUpperCase())
                                                    %>
                                            </span>
                                            <span class="accordion-arrow" aria-hidden="true">&#9654;</span>
                                        </div>
                                        <div class="category-panel hidden" id="cat-<%= cat.name %>-panel">
                                            <div class="category-grid">
                                                <div class="category-card">
                                                    <div class="options-row">
                                                        <div class="category-options-box">
                                                            <div class="category-options-title">Category Options</div>
                                                            <form action="/admin/delete-category" method="POST"
                                                                class="no-margin">
                                                                <input type="hidden" name="category"
                                                                    value="<%= cat.name %>">
                                                                <button type="submit" class="delete-cat-btn"
                                                                    aria-label="Delete category"
                                                                    onclick="return confirm('Delete this category and all its images?');">Delete</button>
                                                            </form>
                                                            <form action="/admin/rename-category" method="POST"
                                                                class="no-margin row-gap" style="margin-top:0.7rem;"
                                                                onsubmit="return confirm('Are you sure you want to rename this category?');">
                                                                <input type="hidden" name="oldName"
                                                                    value="<%= cat.name %>">
                                                                <input type="text" name="newName"
                                                                    placeholder="New category name" required
                                                                    minlength="2" maxlength="50" style="flex:1;">
                                                                <button type="submit"
                                                                    class="btn btn-secondary">Rename</button>
                                                            </form>
                                                        </div>
                                                        <div class="image-options-box">
                                                            <div class="image-options-title">Image Options</div>
                                                            <form class="bulk-delete-form"
                                                                onsubmit="return handleBulkDelete(event, '<%= cat.name %>')">
                                                                <button type="submit" id="bulkDeleteBtn-<%= cat.name %>"
                                                                    class="admin-action-btn btn btn-danger"
                                                                    disabled>Delete
                                                                    Selected</button>
                                                                <button type="button" id="setThumbBtn-<%= cat.name %>"
                                                                    class="admin-action-btn set-thumb-btn btn btn-secondary"
                                                                    disabled
                                                                    onclick="handleSetThumbnail('<%= cat.name %>')">
                                                                    Set as Thumbnail
                                                                </button>
                                                            </form>
                                                            <!-- Move Images Form -->
                                                            <form class="move-images-form"
                                                                onsubmit="return handleMoveImages(event, '<%= cat.name %>')">
                                                                <select name="toCategory" required>
                                                                    <option value="" disabled selected>Move selected
                                                                        to...</option>
                                                                    <% categories.forEach(otherCat=> { if (otherCat.name
                                                                        !== cat.name) { %>
                                                                        <option value="<%= otherCat.name %>">
                                                                            <%= otherCat.name.replace(/-/g, ' ' ) %>
                                                                        </option>
                                                                        <% } }) %>
                                                                </select>
                                                                <button type="submit"
                                                                    class="admin-action-btn btn btn-primary"
                                                                    id="moveImagesBtn-<%= cat.name %>"
                                                                    disabled>Move</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                    <div class="image-grid" data-cat="<%= cat.name %>">
                                                        <% (cat.images || []).forEach((img, i)=> { %>
                                                            <div class="img-item bulk-select-img-item" draggable="true"
                                                                data-filename="<%= img.filename %>" tabindex="0"
                                                                onclick="toggleImageSelect(this)"
                                                                onkeydown="if(event.key===' '||event.key==='Enter'){event.preventDefault();toggleImageSelect(this);}">
                                                                <img src="/images/<%= cat.name %>/<%= img.filename %>"
                                                                    alt="<%= img.alt_text %>">
                                                                <input type="text" class="alt-text-input ml-05"
                                                                    value="<%= img.alt_text %>" placeholder="Alt text"
                                                                    data-image-id="<%= img.id %>"
                                                                    aria-label="Edit alt text">
                                                            </div>
                                                            <% }); %>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </section>
                                    <% }) %>
                            </div>
                            <% } else { %>
                                <p>No categories found.</p>
                                <% } %>
                    </section>
                    <div id="saving-indicator" class="saving-indicator">Saving...</div>
        </div>
        <%- include('partials/dark-mode-toggle') %>
            <script src="/js/admin-manage.js"></script>
</body>

</html>