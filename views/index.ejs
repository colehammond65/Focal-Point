<!-- views/index.ejs -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= settings.siteTitle || "Anne's Photography" %>
  </title>
  <% if (settings.favicon) { %>
    <link rel="icon" type="image/png" href="/uploads/<%= settings.favicon %>">
    <% } %>
      <link rel="stylesheet" href="/styles.css">
</head>

<body>
  <%- include('partials/header', { showAdminNav: false }) %>
    <div class="container">
      <% var loggedIn=typeof loggedIn !=='undefined' ? loggedIn : false; %>

        <% if (images && images.length) { %>
          <!-- Gallery view for a category -->
          <a class="back" href="/">Back to Categories</a>
          <div class="gallery">
            <% images.forEach(img=> { %>
              <img src="/images/<%= category %>/<%= img.filename %>" alt="<%= img.alt_text %>" loading="lazy">
              <% }); %>
          </div>
          <% } else { %>
            <!-- Category grid on homepage -->
            <div class="categories">
              <% categories.forEach(cat=> { %>
                <a class="category" href="/gallery/<%= cat.name %>">
                  <% if (cat.preview) { %>
                    <img src="/images/<%= cat.name %>/<%= cat.preview %>" alt="<%= cat.preview %>">
                    <% } else { %>
                      <div class="no-image">No image</div>
                      <% } %>
                        <div>
                          <%= cat.name.replace(/-/g, ' ' ).replace(/\b\w/g, c=> c.toUpperCase()) %>
                        </div>
                </a>
                <% }); %>
            </div>
            <% } %>

              <!-- Lightbox for viewing images -->
              <div id="lightbox" class="lightbox" role="dialog" aria-modal="true">
                <button class="close-btn" id="closeBtn" aria-label="Close">&times;</button>
                <div class="lightbox-inner">
                  <img id="lightboxImg" src="" alt="">
                  <div id="lightboxAlt" class="lightbox-alt"></div>
                </div>
              </div>

              <script>
                // Lightbox functionality for gallery images
                const images = document.querySelectorAll('.gallery img');
                const lightbox = document.getElementById('lightbox');
                const lightboxImg = document.getElementById('lightboxImg');
                const closeBtn = document.getElementById('closeBtn');

                images.forEach(img => {
                  img.addEventListener('click', (e) => {
                    e.preventDefault();
                    lightboxImg.src = img.src;
                    lightboxImg.alt = img.alt;
                    lightbox.style.display = 'flex';
                    closeBtn.focus();
                    const altBox = document.getElementById('lightboxAlt');
                    if (img.alt && img.alt.trim() !== '') {
                      altBox.textContent = img.alt;
                      altBox.style.display = '';
                    } else {
                      altBox.textContent = '';
                      altBox.style.display = 'none';
                    }
                  });
                });

                closeBtn.addEventListener('click', () => {
                  lightbox.style.display = 'none';
                  lightboxImg.src = '';
                });

                document.addEventListener('keydown', (e) => {
                  if (e.key === 'Escape') {
                    lightbox.style.display = 'none';
                    lightboxImg.src = '';
                  }
                });

                lightbox.addEventListener('click', (e) => {
                  if (e.target === lightbox) {
                    lightbox.style.display = 'none';
                    lightboxImg.src = '';
                  }
                });

                // Fade-in effect for lazy-loaded images
                document.querySelectorAll('.gallery img[loading="lazy"]').forEach(img => {
                  img.addEventListener('load', () => {
                    img.setAttribute('data-loaded', 'true');
                  });
                  // If already cached
                  if (img.complete) {
                    img.setAttribute('data-loaded', 'true');
                  }
                });
              </script>
    </div>
    <%- include('partials/footer') %>
      <%- include('partials/dark-mode-toggle') %>
</body>

</html>